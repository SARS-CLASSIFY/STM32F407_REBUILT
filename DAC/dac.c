#include "dac.h"
//////////////////////////////////////////////////////////////////////////////////	 
//DAC DMA驱动代码
////////////////////////////////////////////////////////////////////////////////// 	
 
 


uint16_t Sine12bit[tableSize]={
0x0800,0x0832,0x0864,0x0897,0x08C9,0x08FB,0x092C,0x095E,0x098F,0x09C1,
0x09F1,0x0A22,0x0A52,0x0A82,0x0AB2,0x0AE1,0x0B0F,0x0B3E,0x0B6B,0x0B98,
0x0BC5,0x0BF1,0x0C1C,0x0C47,0x0C71,0x0C9B,0x0CC3,0x0CEB,0x0D13,0x0D39,
0x0D5F,0x0D83,0x0DA7,0x0DCB,0x0DED,0x0E0E,0x0E2E,0x0E4E,0x0E6C,0x0E8A,
0x0EA6,0x0EC1,0x0EDC,0x0EF5,0x0F0D,0x0F24,0x0F3A,0x0F4F,0x0F63,0x0F76,
0x0F87,0x0F98,0x0FA7,0x0FB5,0x0FC2,0x0FCD,0x0FD8,0x0FE1,0x0FE9,0x0FF0,
0x0FF5,0x0FF9,0x0FFD,0x0FFE,0x0FFF,0x0FFE,0x0FFD,0x0FF9,0x0FF5,0x0FF0,
0x0FE9,0x0FE1,0x0FD8,0x0FCD,0x0FC2,0x0FB5,0x0FA7,0x0F98,0x0F87,0x0F76,
0x0F63,0x0F4F,0x0F3A,0x0F24,0x0F0D,0x0EF5,0x0EDC,0x0EC1,0x0EA6,0x0E8A,
0x0E6C,0x0E4E,0x0E2E,0x0E0E,0x0DED,0x0DCB,0x0DA7,0x0D83,0x0D5F,0x0D39,
0x0D13,0x0CEB,0x0CC3,0x0C9B,0x0C71,0x0C47,0x0C1C,0x0BF1,0x0BC5,0x0B98,
0x0B6B,0x0B3E,0x0B0F,0x0AE1,0x0AB2,0x0A82,0x0A52,0x0A22,0x09F1,0x09C1,
0x098F,0x095E,0x092C,0x08FB,0x08C9,0x0897,0x0864,0x0832,0x0800,0x07CE,
0x079C,0x0769,0x0737,0x0705,0x06D4,0x06A2,0x0671,0x063F,0x060F,0x05DE,
0x05AE,0x057E,0x054E,0x051F,0x04F1,0x04C2,0x0495,0x0468,0x043B,0x040F,
0x03E4,0x03B9,0x038F,0x0365,0x033D,0x0315,0x02ED,0x02C7,0x02A1,0x027D,
0x0259,0x0235,0x0213,0x01F2,0x01D2,0x01B2,0x0194,0x0176,0x015A,0x013F,
0x0124,0x010B,0x00F3,0x00DC,0x00C6,0x00B1,0x009D,0x008A,0x0079,0x0068,
0x0059,0x004B,0x003E,0x0033,0x0028,0x001F,0x0017,0x0010,0x000B,0x0007,
0x0003,0x0002,0x0001,0x0002,0x0003,0x0007,0x000B,0x0010,0x0017,0x001F,
0x0028,0x0033,0x003E,0x004B,0x0059,0x0068,0x0079,0x008A,0x009D,0x00B1,
0x00C6,0x00DC,0x00F3,0x010B,0x0124,0x013F,0x015A,0x0176,0x0194,0x01B2,
0x01D2,0x01F2,0x0213,0x0235,0x0259,0x027D,0x02A1,0x02C7,0x02ED,0x0315,
0x033D,0x0365,0x038F,0x03B9,0x03E4,0x040F,0x043B,0x0468,0x0495,0x04C2,
0x04F1,0x051F,0x054E,0x057E,0x05AE,0x05DE,0x060F,0x063F,0x0671,0x06A2,
0x06D4,0x0705,0x0737,0x0769,0x079C,0x07CE,
};//正弦向量表
//DAC双通道的初始化



uint16_t Rec12bit[tableSize] = {
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,0X0FFF,
0X0FFF,0X0FFF,0X0FFF,0X0FFF,
};//方波向量表


uint16_t sawtooth[tableSize]= {
0X0000,0X0010,0X0020,0X0030,0X0040,0X0050,0X0060,0X0070,0X0080,0X0090,0X00A0,0X00B0,
0X00C0,0X00D0,0X00E0,0X00F0,0X0100,0X0110,0X0120,0X0130,0X0140,0X0150,0X0160,0X0170,
0X0180,0X0190,0X01A0,0X01B0,0X01C0,0X01D0,0X01E0,0X01F0,0X0200,0X0210,0X0220,0X0230,
0X0240,0X0250,0X0260,0X0270,0X0280,0X0290,0X02A0,0X02B0,0X02C0,0X02D0,0X02E0,0X02F0,
0X0300,0X0310,0X0320,0X0330,0X0340,0X0350,0X0360,0X0370,0X0380,0X0390,0X03A0,0X03B0,
0X03C0,0X03D0,0X03E0,0X03F0,0X0400,0X0410,0X0420,0X0430,0X0440,0X0450,0X0460,0X0470,
0X0480,0X0490,0X04A0,0X04B0,0X04C0,0X04D0,0X04E0,0X04F0,0X0500,0X0510,0X0520,0X0530,
0X0540,0X0550,0X0560,0X0570,0X0580,0X0590,0X05A0,0X05B0,0X05C0,0X05D0,0X05E0,0X05F0,
0X0600,0X0610,0X0620,0X0630,0X0640,0X0650,0X0660,0X0670,0X0680,0X0690,0X06A0,0X06B0,
0X06C0,0X06D0,0X06E0,0X06F0,0X0700,0X0710,0X0720,0X0730,0X0740,0X0750,0X0760,0X0770,
0X0780,0X0790,0X07A0,0X07B0,0X07C0,0X07D0,0X07E0,0X07F0,0X0800,0X080F,0X081F,0X082F,
0X083F,0X084F,0X085F,0X086F,0X087F,0X088F,0X089F,0X08AF,0X08BF,0X08CF,0X08DF,0X08EF,
0X08FF,0X090F,0X091F,0X092F,0X093F,0X094F,0X095F,0X096F,0X097F,0X098F,0X099F,0X09AF,
0X09BF,0X09CF,0X09DF,0X09EF,0X09FF,0X0A0F,0X0A1F,0X0A2F,0X0A3F,0X0A4F,0X0A5F,0X0A6F,
0X0A7F,0X0A8F,0X0A9F,0X0AAF,0X0ABF,0X0ACF,0X0ADF,0X0AEF,0X0AFF,0X0B0F,0X0B1F,0X0B2F,
0X0B3F,0X0B4F,0X0B5F,0X0B6F,0X0B7F,0X0B8F,0X0B9F,0X0BAF,0X0BBF,0X0BCF,0X0BDF,0X0BEF,
0X0BFF,0X0C0F,0X0C1F,0X0C2F,0X0C3F,0X0C4F,0X0C5F,0X0C6F,0X0C7F,0X0C8F,0X0C9F,0X0CAF,
0X0CBF,0X0CCF,0X0CDF,0X0CEF,0X0CFF,0X0D0F,0X0D1F,0X0D2F,0X0D3F,0X0D4F,0X0D5F,0X0D6F,
0X0D7F,0X0D8F,0X0D9F,0X0DAF,0X0DBF,0X0DCF,0X0DDF,0X0DEF,0X0DFF,0X0E0F,0X0E1F,0X0E2F,
0X0E3F,0X0E4F,0X0E5F,0X0E6F,0X0E7F,0X0E8F,0X0E9F,0X0EAF,0X0EBF,0X0ECF,0X0EDF,0X0EEF,
0X0EFF,0X0F0F,0X0F1F,0X0F2F,0X0F3F,0X0F4F,0X0F5F,0X0F6F,0X0F7F,0X0F8F,0X0F9F,0X0FAF,
0X0FBF,0X0FCF,0X0FDF,0X0FEF,
};//锯齿波向量表

uint16_t Tri_12bit[tableSize] = {
0X0000,0X0020,0X0040,0X0060,0X0080,0X00A0,0X00C0,0X00E0,0X0100,0X0120,0X0140,0X0160,
0X0180,0X01A0,0X01C0,0X01E0,0X0200,0X0220,0X0240,0X0260,0X0280,0X02A0,0X02C0,0X02E0,
0X0300,0X0320,0X0340,0X0360,0X0380,0X03A0,0X03C0,0X03E0,0X0400,0X0420,0X0440,0X0460,
0X0480,0X04A0,0X04C0,0X04E0,0X0500,0X0520,0X0540,0X0560,0X0580,0X05A0,0X05C0,0X05E0,
0X0600,0X0620,0X0640,0X0660,0X0680,0X06A0,0X06C0,0X06E0,0X0700,0X0720,0X0740,0X0760,
0X0780,0X07A0,0X07C0,0X07E0,0X0800,0X081F,0X083F,0X085F,0X087F,0X089F,0X08BF,0X08DF,
0X08FF,0X091F,0X093F,0X095F,0X097F,0X099F,0X09BF,0X09DF,0X09FF,0X0A1F,0X0A3F,0X0A5F,
0X0A7F,0X0A9F,0X0ABF,0X0ADF,0X0AFF,0X0B1F,0X0B3F,0X0B5F,0X0B7F,0X0B9F,0X0BBF,0X0BDF,
0X0BFF,0X0C1F,0X0C3F,0X0C5F,0X0C7F,0X0C9F,0X0CBF,0X0CDF,0X0CFF,0X0D1F,0X0D3F,0X0D5F,
0X0D7F,0X0D9F,0X0DBF,0X0DDF,0X0DFF,0X0E1F,0X0E3F,0X0E5F,0X0E7F,0X0E9F,0X0EBF,0X0EDF,
0X0EFF,0X0F1F,0X0F3F,0X0F5F,0X0F7F,0X0F9F,0X0FBF,0X0FDF,0X0FFF,0X0FDF,0X0FBF,0X0F9F,
0X0F7F,0X0F5F,0X0F3F,0X0F1F,0X0EFF,0X0EDF,0X0EBF,0X0E9F,0X0E7F,0X0E5F,0X0E3F,0X0E1F,
0X0DFF,0X0DDF,0X0DBF,0X0D9F,0X0D7F,0X0D5F,0X0D3F,0X0D1F,0X0CFF,0X0CDF,0X0CBF,0X0C9F,
0X0C7F,0X0C5F,0X0C3F,0X0C1F,0X0BFF,0X0BDF,0X0BBF,0X0B9F,0X0B7F,0X0B5F,0X0B3F,0X0B1F,
0X0AFF,0X0ADF,0X0ABF,0X0A9F,0X0A7F,0X0A5F,0X0A3F,0X0A1F,0X09FF,0X09DF,0X09BF,0X099F,
0X097F,0X095F,0X093F,0X091F,0X08FF,0X08DF,0X08BF,0X089F,0X087F,0X085F,0X083F,0X081F,
0X0800,0X07E0,0X07C0,0X07A0,0X0780,0X0760,0X0740,0X0720,0X0700,0X06E0,0X06C0,0X06A0,
0X0680,0X0660,0X0640,0X0620,0X0600,0X05E0,0X05C0,0X05A0,0X0580,0X0560,0X0540,0X0520,
0X0500,0X04E0,0X04C0,0X04A0,0X0480,0X0460,0X0440,0X0420,0X0400,0X03E0,0X03C0,0X03A0,
0X0380,0X0360,0X0340,0X0320,0X0300,0X02E0,0X02C0,0X02A0,0X0280,0X0260,0X0240,0X0220,
0X0200,0X01E0,0X01C0,0X01A0,0X0180,0X0160,0X0140,0X0120,0X0100,0X00E0,0X00C0,0X00A0,
0X0080,0X0060,0X0040,0X0020,
};//三角波向量表

void Dac1_Init(void)
{  
  GPIO_InitTypeDef  GPIO_InitStructure;
  DAC_InitTypeDef DAC_InitType;
	
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);//使能GPIOA时钟
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_DAC, ENABLE);//使能DAC时钟
	   
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4|GPIO_Pin_5;//选择两个通道的引脚 ***><***
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AN;//模拟输入
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_DOWN;//下拉
  GPIO_Init(GPIOA, &GPIO_InitStructure);//初始化

  DAC_InitType.DAC_Trigger=DAC_Trigger_T6_TRGO;;	//使用定时器6触发    
  DAC_InitType.DAC_WaveGeneration=DAC_WaveGeneration_None;//不使用波形发生
  DAC_InitType.DAC_LFSRUnmask_TriangleAmplitude=DAC_LFSRUnmask_Bit0;//屏蔽、幅值设置
  DAC_InitType.DAC_OutputBuffer=DAC_OutputBuffer_Disable ;	//DAC1输出缓存关闭 BOFF1=1
/******************DAC1开启***************************************************/	
  DAC_Init(DAC_Channel_1,&DAC_InitType);	 //初始化DAC通道1
  DAC_Cmd(DAC_Channel_1, ENABLE);  //使能DAC通道1
  DAC_DMACmd(DAC_Channel_1, ENABLE); //使能DAC通道1的DMA 
	
/*****************DAC2开启***************************************************/
  DAC_InitType.DAC_Trigger=DAC_Trigger_T2_TRGO;;	//使用定时器2触发  
  DAC_Init(DAC_Channel_2, &DAC_InitType);//初始化	***><***
  DAC_Cmd(DAC_Channel_2, ENABLE);    //使能DAC的通道2	***><*** 
  DAC_DMACmd(DAC_Channel_2, ENABLE); //使能DAC通道2的DMA 

  DAC_SetChannel1Data(DAC_Align_12b_R, 0);  //12位右对齐数据格式设置DAC值
}

//设置通道1输出电压
//vol:0~3300,代表0~3.3V
void Dac1_Set_Vol(u16 vol)
{
	double temp=vol;
	temp/=1000;
	temp=temp*4096/3.3;
	DAC_SetChannel1Data(DAC_Align_12b_R,temp);//12位右对齐数据格式设置DAC值
}



/****************************DMA传输时钟频率设置,用于控制发生波形频率***********
** brief: 可以方便地设置DAC频率 
** ARR PSC: 频率设置参数
** TIMX : 通过DAC的触发方式来选择 此处选择TIM6
** fre  :设置的频率
********************************************************************************/
void DAC1_TIM_Config(uint32_t fre)
{
	
  TIM_TimeBaseInitTypeDef    TIM_TimeBaseStructure;
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM6, ENABLE);
	
  TIM_TimeBaseStructInit(&TIM_TimeBaseStructure); 
  TIM_TimeBaseStructure.TIM_Period = 328125/fre;//ARR      									 
  TIM_TimeBaseStructure.TIM_Prescaler = 0x00;//PSC       							
  TIM_TimeBaseStructure.TIM_ClockDivision = 0x0;    						
  TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  	//向上计数模式
  TIM_TimeBaseInit(TIM6, &TIM_TimeBaseStructure);
 
  TIM_SelectOutputTrigger(TIM6, TIM_TRGOSource_Update);
 
  TIM_Cmd(TIM6, ENABLE);
 
}


/****************************DMA传输时钟频率设置,用于控制发生波形频率***********
** brief: 可以方便地设置DAC频率 
** ARR PSC: 频率设置参数
** TIMX : 通过DAC的触发方式来选择 此处选择TIM6
** fre  :设置的频率
********************************************************************************/
void DAC2_TIM_Config(uint32_t fre)
{
	
  TIM_TimeBaseInitTypeDef    TIM_TimeBaseStructure;
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);
	
  TIM_TimeBaseStructInit(&TIM_TimeBaseStructure); 
  TIM_TimeBaseStructure.TIM_Period = 328125/fre;//ARR      									 
  TIM_TimeBaseStructure.TIM_Prescaler = 0x00;//PSC       							
  TIM_TimeBaseStructure.TIM_ClockDivision = 0x0;    						
  TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  	//向上计数模式
  TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);
 
  TIM_SelectOutputTrigger(TIM2, TIM_TRGOSource_Update);
 
  TIM_Cmd(TIM2, ENABLE);
 
}
/***********************DMA传输设置*****************************************
** 传输数据大小  :tableSize
** 外设地址  :DAC_DHR12R1
** 内存地址  :Sine12bit
***************************************************************************/
void DAC_DMA_Config(void)
{	
  DMA_InitTypeDef  DMA_InitStructure;
  /* 使能DMA1时钟 */
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_DMA1, ENABLE);	
  /* 配置DMA1 */
  DMA_InitStructure.DMA_Channel = DMA_Channel_7;  
  DMA_InitStructure.DMA_PeripheralBaseAddr = DAC_DHR12R1;				        //外设数据地址
  DMA_InitStructure.DMA_Memory0BaseAddr = (uint32_t)&Sine12bit ;			//内存数据地址 DualSine12bit
  DMA_InitStructure.DMA_DIR = DMA_DIR_MemoryToPeripheral;						//数据传输方向内存至外设
  DMA_InitStructure.DMA_BufferSize = tableSize;										//缓存大小为32字节	
  DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;				//外设数据地址固定	
  DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;						//内存数据地址自增
  DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;	//HALFWORD
  DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;		    //HALFWORD
  DMA_InitStructure.DMA_Mode = DMA_Mode_Circular;								//循环模式
  DMA_InitStructure.DMA_Priority = DMA_Priority_High;							//高DMA通道优先级
  DMA_InitStructure.DMA_FIFOMode = DMA_FIFOMode_Disable;         
  DMA_InitStructure.DMA_FIFOThreshold = DMA_FIFOThreshold_HalfFull;
  DMA_InitStructure.DMA_MemoryBurst = DMA_MemoryBurst_Single;
  DMA_InitStructure.DMA_PeripheralBurst = DMA_PeripheralBurst_Single;		    //非内存至内存模式	
  //DAC1的DMA使能
  DMA_Init(DMA1_Stream5, &DMA_InitStructure);
  DMA_Cmd(DMA1_Stream5, ENABLE);
  //DAC2的DMA使能
  DMA_InitStructure.DMA_Memory0BaseAddr = (uint32_t)&Tri_12bit ;				//更改输出波形  ***>_<***
  DMA_InitStructure.DMA_PeripheralBaseAddr = DAC_DHR12R2;	
  DMA_Init(DMA1_Stream6, &DMA_InitStructure);
  DMA_Cmd(DMA1_Stream6, ENABLE);
}


/***********************DACVPP设置*****************************************
** 传输数据大小  :tableSize
** 内存地址  :wave 
** vpp:  所设定的VPP 3300=3.3v
***************************************************************************/
void set_vol(uint16_t VPP, uint16_t * wave)
{
	int i;
	for(i=0;i<tableSize;i++){
		wave[i] = wave[i]*VPP/3300;
	}
}